<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø´Ø§Øª Ø§Ù„Ù…Ù„ÙˆÙƒ - ØºØ±Ù ÙˆÙ…Ø­Ø§Ø¯Ø«Ø§Øª</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    .layout { display:flex; gap:10px; width:95%; max-width:1100px; margin:20px auto; }
    .sidebar { width:260px; background:#111; border:2px solid gold; border-radius:12px; padding:10px; }
    .main { flex:1; background:#111; border:2px solid gold; border-radius:12px; padding:10px; display:flex; flex-direction:column; height:75vh; }
    .rooms-list { list-style:none; padding:0; margin:0; }
    .rooms-list li { padding:8px; border-bottom:1px solid rgba(255,215,0,0.05); cursor:pointer; color:gold; }
    .rooms-list li:hover { background: rgba(255,215,0,0.06); }
    .profile-box { text-align:center; margin-bottom:10px; color:gold; }
    .messages { flex:1; overflow:auto; padding:10px; background:#000; border-radius:8px; color:gold; }
    .input-row { display:flex; gap:8px; margin-top:10px; }
    .small-btn { background:gold; border:none; padding:8px; border-radius:8px; cursor:pointer; }
    .mod-actions { margin-top:8px; display:flex; gap:6px; flex-wrap:wrap; }
  </style>
</head>
<body>
  <div class="layout">
    <div class="sidebar">
      <div class="profile-box">
        <div id="meName">...Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„</div>
        <div id="meRole" style="font-size:13px;color:#ddd"></div>
      </div>
      <h4 style="color:gold">Ø§Ù„ØºØ±Ù Ø§Ù„Ø¹Ø§Ù…Ø©</h4>
      <ul id="rooms" class="rooms-list"></ul>
      <hr style="border-color:rgba(255,215,0,0.1)"/>
      <button id="createPrivateBtn" class="small-btn">Ù…Ø­Ø§Ø¯Ø«Ø© Ø®Ø§ØµØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
      <div style="margin-top:8px"><button id="broadcastBtn" class="small-btn">Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¹Ø§Ù…Ø©</button></div>
      <div class="mod-actions" id="ownerActions" style="display:none"></div>
    </div>

    <div class="main">
      <div id="roomHeader" style="padding:6px;color:gold;font-weight:bold">Ø§Ù„ØºØ±ÙØ©: Ø¹Ø§Ù…Ø©</div>
      <div id="messages" class="messages"></div>
      <div class="input-row">
        <input id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." style="flex:1;padding:8px;border-radius:8px;background:#000;color:gold;border:1px solid rgba(255,215,0,0.2)"/>
        <button id="sendBtn" class="small-btn">Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth, db, createPrivateRoom, sendMessage, listenRoomMessages, listenBroadcasts, getProfile, promoteUser, muteUser, banUser, sendBroadcast, shortName } from './script.js';
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const PUBLIC_ROOMS = [
      { id: 'general', name: 'Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©' },
      { id: 'iraq', name: 'Ø±ÙˆÙ… Ø§Ù„Ø¹Ø±Ø§Ù‚ ğŸ‡®ğŸ‡¶' },
      { id: 'sa', name: 'Ø±ÙˆÙ… Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© ğŸ‡¸ğŸ‡¦' },
      { id: 'eg', name: 'Ø±ÙˆÙ… Ù…ØµØ± ğŸ‡ªğŸ‡¬' },
      { id: 'sy', name: 'Ø±ÙˆÙ… Ø³ÙˆØ±ÙŠØ§ ğŸ‡¸ğŸ‡¾' },
      { id: 'lb', name: 'Ø±ÙˆÙ… Ù„Ø¨Ù†Ø§Ù† ğŸ‡±ğŸ‡§' },
      { id: 'jo', name: 'Ø±ÙˆÙ… Ø§Ù„Ø§Ø±Ø¯Ù† ğŸ‡¯ğŸ‡´' },
      { id: 'kw', name: 'Ø±ÙˆÙ… Ø§Ù„ÙƒÙˆÙŠØª ğŸ‡°ğŸ‡¼' },
      { id: 'bh', name: 'Ø±ÙˆÙ… Ø§Ù„Ø¨Ø­Ø±ÙŠÙ† ğŸ‡§ğŸ‡­' },
      { id: 'ae', name: 'Ø±ÙˆÙ… Ø§Ù„Ø§Ù…Ø§Ø±Ø§Øª ğŸ‡¦ğŸ‡ª' },
      { id: 'om', name: 'Ø±ÙˆÙ… Ø¹Ù…Ø§Ù† ğŸ‡´ğŸ‡²' },
      { id: 'qa', name: 'Ø±ÙˆÙ… Ù‚Ø·Ø± ğŸ‡¶ğŸ‡¦' },
      { id: 'left', name: 'Ø±ÙˆÙ… Ø§Ù„ÙŠÙ…ÙŠÙ† ğŸ‡¾ğŸ‡ª' },
      { id: 'west', name: 'Ø±ÙˆÙ… Ø§Ù„Ù…ØªØºØ±Ø¨ÙŠÙ† âœˆï¸' },
    ];

    let currentRoom = 'general';
    let currentUser = null;
    let roomListener = null;

    const roomsUl = document.getElementById("rooms");
    const messagesDiv = document.getElementById("messages");
    const msgInput = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");
    const meName = document.getElementById("meName");
    const meRole = document.getElementById("meRole");
    const broadcastBtn = document.getElementById("broadcastBtn");
    const ownerActionsDiv = document.getElementById("ownerActions");

    // populate rooms
    for (const r of PUBLIC_ROOMS) {
      const li = document.createElement('li');
      li.textContent = r.name;
      li.dataset.room = r.id;
      li.addEventListener('click', () => openRoom(r.id, r.name));
      roomsUl.appendChild(li);
    }

    function openRoom(id, displayName) {
      currentRoom = id;
      document.getElementById("roomHeader").textContent = 'Ø§Ù„ØºØ±ÙØ©: ' + displayName;
      if (roomListener) roomListener(); // unsubscribe
      messagesDiv.innerHTML = '';
      roomListener = listenRoomMessages(id, renderMessages);
    }

    function renderMessages(arr) {
      messagesDiv.innerHTML = '';
      for (const m of arr) {
        const div = document.createElement('div');
        div.className = 'message';
        div.textContent = `${shortName(m.user)}: ${m.text}`;
        if (currentUser && m.user === currentUser.email) { div.style.background='gold'; div.style.color='black'; }
        messagesDiv.appendChild(div);
      }
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    sendBtn.addEventListener('click', async () => {
      const text = msgInput.value.trim();
      if (!text || !currentUser) return;
      // role check example
      if (currentUser.role === 'muted') { alert('ØªÙ… ÙƒØªÙ…ÙƒØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„'); return; }
      await sendMessage(currentRoom, currentUser.email, text);
      msgInput.value='';
    });

    broadcastBtn.addEventListener('click', async () => {
      if (!currentUser) return;
      if (currentUser.role !== 'owner' && currentUser.role !== 'admin') { alert('Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¨Ø«'); return; }
      const text = prompt('Ù†Øµ Ø§Ù„Ø¨Ø« Ø§Ù„Ø¹Ø§Ù…:');
      if (!text) return;
      await sendBroadcast(currentUser.email, text);
    });

    document.getElementById("createPrivateBtn").addEventListener('click', async () => {
      const other = prompt('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ù…Ø­Ø§Ø¯Ø«ØªÙ‡ (email):');
      if (!other) return;
      // find user by email -> get UID
      const profilesCol = collection(db, 'profiles');
      const q = query(profilesCol);
      const snap = await getDocs(q);
      let targetUid = null;
      snap.forEach(d => { const data = d.data(); if (data.email === other) targetUid = d.id; });
      if (!targetUid) { alert('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }
      const roomId = await createPrivateRoom(currentUser.uid, targetUid);
      openRoom(roomId, 'Ø®Ø§Øµ');
    });

    onAuthStateChanged(getAuth(), async (u) => {
      if (!u) { window.location.href = 'login.html'; return; }
      currentUser = await getProfile(u.uid) || { displayName: shortName(u.email), email: u.email, role: 'user', uid: u.uid };
      meName.textContent = currentUser.displayName || shortName(currentUser.email);
      meRole.textContent = 'Ø§Ù„Ø±ØªØ¨Ø©: ' + (currentUser.role || 'Ù…Ø³ØªØ®Ø¯Ù…');
      // show owner actions if owner
      if (currentUser.email === 'your-owner-email@example.com') {
        ownerActionsDiv.style.display='block';
        const btnPromote = document.createElement('button'); btnPromote.textContent='ØªØ±Ù‚ÙŠØ© Ø¹Ø¶Ùˆ'; btnPromote.className='small-btn';
        btnPromote.onclick = async ()=>{ const e=prompt('Ø§Ø¯Ø®Ù„ uid Ø§Ù„Ø¹Ø¶Ùˆ'); const role=prompt('Ø§Ø¯Ø®Ù„ Ø§Ù„Ø±ØªØ¨Ø© (user, vip, advanced, admin, owner)'); if(e && role) await promoteUser(e, role); alert('ØªÙ…Øª Ø§Ù„ØªØ±Ù‚ÙŠØ©'); };
        ownerActionsDiv.appendChild(btnPromote);
        const btnMute = document.createElement('button'); btnMute.textContent='ÙƒØªÙ…'; btnMute.className='small-btn';
        btnMute.onclick = async ()=>{ const e=prompt('Ø§Ø¯Ø®Ù„ uid Ø§Ù„Ø¹Ø¶Ùˆ'); const m=prompt('Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„ÙƒØªÙ…'); if(e && m) await muteUser(e, parseInt(m)); alert('ØªÙ… Ø§Ù„ÙƒØªÙ…'); };
        ownerActionsDiv.appendChild(btnMute);
        const btnBan = document.createElement('button'); btnBan.textContent='Ø­Ø¸Ø±'; btnBan.className='small-btn';
        btnBan.onclick = async ()=>{ const e=prompt('Ø§Ø¯Ø®Ù„ uid Ø§Ù„Ø¹Ø¶Ùˆ'); if(e) await banUser(e); alert('ØªÙ… Ø§Ù„Ø­Ø¸Ø±'); };
        ownerActionsDiv.appendChild(btnBan);
      }

      openRoom('general', 'Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©');
    });
  </script>
</body>
</html>