<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ‘‘ Ø´Ø§Øª Ø§Ù„Ù…Ù„ÙˆÙƒ â€” Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ÙˆØ§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ğŸ‘‘</title>
  <style>
    :root{
      --gold1:#ffd700;
      --gold2:#e6b800;
      --gold3:#b8860b;
      --bg:#000;
      --card:#111;
      --muted:#777;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Tajawal",sans-serif;
      background: linear-gradient(180deg, #050505 0%, #0b0b0b 100%);
      color: var(--gold1);
      display:flex;
      align-items:center;
      justify-content:center;
      height:100vh;
      overflow:hidden;
    }

    /* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø´Ø§Øª */
    .chat-box{
      width:94%;
      max-width:980px;
      height:88vh;
      background: linear-gradient(180deg,#0f0f10 0%, #0b0b0b 100%);
      border-radius:14px;
      border:2px solid rgba(212,175,55,0.12);
      box-shadow: 0 8px 40px rgba(0,0,0,0.7), 0 0 30px rgba(212,175,55,0.06) inset;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:18px;
      padding:18px;
      position:relative;
    }

    /* Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠÙ…Ù† (Ø§Ù„Ø´Ø§Øª) */
    .chat-area{
      background: linear-gradient(180deg,#070707,#0b0b0b);
      border-radius:10px;
      padding:12px;
      display:flex;
      flex-direction:column;
      border:1px solid rgba(212,175,55,0.06);
    }

    .header{
      background: linear-gradient(90deg,var(--gold2),var(--gold1));
      color:#050505;
      padding:10px;
      border-radius:8px;
      font-weight:700;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      box-shadow: 0 4px 18px rgba(214,170,20,0.15);
    }

    /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ */
    .profile-icon{
      position:absolute;
      top:12px;
      left:12px; /* because layout is rtl, left places icon visually on right side of page */
      width:56px;
      height:56px;
      border-radius:50%;
      background: radial-gradient(circle at 30% 30%, var(--gold1), var(--gold2) 55%, var(--gold3));
      box-shadow: 0 6px 22px rgba(214,170,20,0.45), 0 0 30px rgba(214,170,20,0.18) inset;
      border: 2px solid rgba(255,255,255,0.08);
      cursor:pointer;
      transform-style:preserve-3d;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      transition: transform .35s ease, box-shadow .25s ease;
      perspective: 800px;
      z-index:40;
    }

    /* ØµÙˆØ±Ø© ØµØºÙŠØ±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø§ÙŠÙ‚ÙˆÙ†Ø© Ø¥Ù† ÙˆÙØ¬Ø¯Øª */
    .profile-icon img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    .profile-icon:hover{ transform: rotateY(12deg) scale(1.03); box-shadow:0 10px 40px rgba(214,170,20,0.6); }

    /* Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø´Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙŠØ³Ø±: Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
    .side{
      width:100%;
      max-width:320px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .user-card{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:12px;
      padding:14px;
      border:1px solid rgba(212,175,55,0.06);
      box-shadow: 0 6px 18px rgba(0,0,0,0.6);
    }
    .user-card h3{ margin:0 0 6px 0; color:var(--gold1); }
    .user-card p{ margin:6px 0; color:var(--muted); font-size:14px }

    /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
    #messages{
      flex:1;
      overflow:auto;
      padding:8px;
      border-radius:8px;
      background:linear-gradient(180deg,#020202, #060606);
      border:1px solid rgba(255,255,255,0.02);
      color:var(--gold1);
    }
    .msg{ padding:8px 10px; margin:8px 0; border-radius:10px; background:#111; color:#eee; max-width:75%; }
    .msg.me{ background:var(--gold1); color:#050505; margin-left:auto; text-align:right; }

    .input-area{ display:flex; gap:8px; margin-top:10px; align-items:center }
    .input-area input{ flex:1; padding:10px 12px; border-radius:8px; background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--gold1) }

    .btn{ background:linear-gradient(90deg,var(--gold2),var(--gold1)); color:#050505; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:700 }

    /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ (Ù…Ø±Ø¨Ø¹Ø© ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠØ©) */
    .profile-popup{
      display:none;
      position:absolute;
      top:24px;
      left:calc(100% - 300px); /* ØªØ¸Ù‡Ø± ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† Ø¨ØµÙ†Ø¯ÙˆÙ‚ ÙÙˆÙ‚ Ø§Ù„Ø´Ø§Øª */
      width:300px;
      background: linear-gradient(180deg, rgba(20,20,20,0.98), rgba(12,12,12,0.98));
      border-radius:12px;
      border:2px solid rgba(212,175,55,0.15);
      padding:14px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.7), 0 0 30px rgba(212,175,55,0.08) inset;
      z-index:60;
      transform-origin: top right;
      animation: popIn .22s ease;
    }
    @keyframes popIn{
      from{ opacity:0; transform: translateY(-8px) scale(.98) }
      to{ opacity:1; transform: translateY(0) scale(1) }
    }

    .profile-popup .close{
      position:absolute;
      top:8px;
      right:8px; /* Ù„Ø£Ù† Ø§Ù„ØµÙØ­Ø© rtlØŒ right = Ø£Ø¹Ù„Ù‰ ÙŠØ³Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨ØµØ±ÙŠØ§Ù‹ */
      color:var(--gold1);
      background:transparent;
      border:none;
      font-size:20px;
      cursor:pointer;
    }

    .profile-popup img{
      width:92px; height:92px; object-fit:cover; border-radius:50%;
      border:2px solid rgba(212,175,55,0.9); box-shadow:0 6px 20px rgba(214,170,20,0.18);
      display:block; margin:6px auto 10px;
    }
    .profile-popup input, .profile-popup textarea, .profile-popup select{
      width:100%; padding:8px; margin:6px 0; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:var(--gold1); text-align:center
    }
    .profile-popup textarea{ min-height:64px; resize:vertical }

    .success-toast{
      position:fixed;
      top:20px;
      left:50%;
      transform:translateX(-50%);
      background: linear-gradient(90deg,var(--gold1),var(--gold2));
      color:#050505;
      padding:10px 18px;
      border-radius:12px;
      box-shadow:0 8px 30px rgba(214,170,20,0.25);
      display:none;
      z-index:120;
      font-weight:800;
    }

    /* responsive */
    @media (max-width:900px){
      .chat-box{ grid-template-columns: 1fr; padding:12px; height:94vh;}
      .profile-popup{ left:auto; right:14px; top:16px; width:92%; }
      .profile-icon{ left:12px; top:8px }
    }
  </style>
</head>
<body>

  <div class="chat-box" id="chatBox">
    <!-- Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠØ³Ø±: Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø³Ø±ÙŠØ¹Ø©) -->
    <div class="side">
      <div class="user-card">
        <h3 id="displayName">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
        <p id="displayEmail">user@example.com</p>
        <p id="displayAgeGender">â€”</p>
        <p id="displayBio" style="color:var(--muted)">Ø§Ù„Ù†Ø¨Ø°Ø©: â€”</p>
      </div>
      <div class="user-card">
        <h3>Ø®ÙŠØ§Ø±Ø§Øª</h3>
        <button id="openProfileBtn" class="btn" style="width:100%;">ÙØªØ­ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</button>
        <button id="logoutBtn" class="btn" style="background:crimson;margin-top:10px;color:#fff">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>

    <!-- Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠÙ…Ù†: Ø§Ù„Ø´Ø§Øª -->
    <div class="chat-area" id="rightArea">
      <div class="header">ğŸ‘‘ Ø´Ø§Øª Ø§Ù„Ù…Ù„ÙˆÙƒ ğŸ‘‘
        <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ -->
        <div class="profile-icon" id="profileIcon" title="Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ">
          <!-- ØµÙˆØ±Ø© Avatar Ø³ØªÙˆØ¶Ø¹ Ù‡Ù†Ø§ Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯Øª -->
        </div>
      </div>

      <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
      <div class="profile-popup" id="profilePopup" role="dialog" aria-modal="true">
        <button class="close" id="closePopup">âŒ</button>
        <img id="profileImage" src="default.png" alt="Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©">
        <input type="file" id="imageInput" accept="image/*" />
        <input type="text" id="userName" placeholder="Ø§Ù„Ø§Ø³Ù…" />
        <input type="number" id="userAge" placeholder="Ø§Ù„Ø¹Ù…Ø±" />
        <select id="userGender">
          <option value="">Ø§Ù„Ø¬Ù†Ø³</option>
          <option value="Ø°ÙƒØ±">Ø°ÙƒØ±</option>
          <option value="Ø£Ù†Ø«Ù‰">Ø£Ù†Ø«Ù‰</option>
        </select>
        <textarea id="userBio" placeholder="Ù†Ø¨Ø°Ø© Ù‚ØµÙŠØ±Ø©..."></textarea>
        <button id="saveBtn" class="btn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
      </div>

      <!-- Ø±Ø³Ø§Ø¦Ù„ -->
      <div id="messages"></div>

      <!-- Ø¥Ø±Ø³Ø§Ù„ -->
      <div class="input-area" style="margin-top:12px">
        <input id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." />
        <button id="sendBtn" class="btn">Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
    </div>
  </div>

  <!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ -->
  <div class="success-toast" id="successToast">âœ… ØªÙ… Ø­ÙØ¸ Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ Ø¨Ù†Ø¬Ø§Ø­!</div>

  <!-- Firebase & Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-storage.js";

    // ====== Ø¶Ø¹ Ù‡Ù†Ø§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹ Firebase (Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¹Ù†Ø¯Ùƒ Ø¨Ø§Ù„ÙØ¹Ù„) ======
    const firebaseConfig = {
      apiKey: "AIzaSyDJhA1WkFsLZiQz5WZFWPFbdjxLPtG57ss",
      authDomain: "lloo-756f7.firebaseapp.com",
      projectId: "lloo-756f7",
      storageBucket: "lloo-756f7.firebasestorage.app",
      messagingSenderId: "951071688513",
      appId: "1:951071688513:web:46f402720b38f15c5043c0"
    };
    // ===================================================================

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù€ DOM
    const profileIcon = document.getElementById('profileIcon');
    const profilePopup = document.getElementById('profilePopup');
    const openProfileBtn = document.getElementById('openProfileBtn');
    const closePopup = document.getElementById('closePopup');
    const imageInput = document.getElementById('imageInput');
    const profileImage = document.getElementById('profileImage');
    const saveBtn = document.getElementById('saveBtn');
    const successToast = document.getElementById('successToast');

    const displayName = document.getElementById('displayName');
    const displayEmail = document.getElementById('displayEmail');
    const displayAgeGender = document.getElementById('displayAgeGender');
    const displayBio = document.getElementById('displayBio');

    const messagesDiv = document.getElementById('messages');
    const sendBtn = document.getElementById('sendBtn');
    const messageInput = document.getElementById('messageInput');

    let currentUser = null;
    let currentPhotoFile = null;

    // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨ÙˆØ¨ Ø£Ø¨
    function openPopup(){ profilePopup.style.display = 'block'; }
    function closePopupFunc(){ profilePopup.style.display = 'none'; }

    profileIcon.addEventListener('click', openPopup);
    openProfileBtn.addEventListener('click', openPopup);
    closePopup.addEventListener('click', closePopupFunc);

    // Ø¥ØºÙ„Ø§Ù‚ Ù„Ùˆ Ø¶ØºØ· Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø§ÙØ°Ø©
    document.addEventListener('click', (e) => {
      if (!profilePopup.contains(e.target) && !profileIcon.contains(e.target) && profilePopup.style.display==='block'){
        closePopupFunc();
      }
    });

    // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // Ù„Ùˆ Ù…Ùˆ Ù…Ø³Ø¬Ù„ ÙŠØ±Ø¬Ø¹ Ù„Ù„ØªØ³Ø¬ÙŠÙ„
        window.location.href = 'login.html';
        return;
      }
      currentUser = user;
      displayEmail.textContent = user.email || '';
      displayName.textContent = user.displayName || 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
      // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firestore
      try {
        const docRef = doc(db, 'users', user.uid);
        const snap = await getDoc(docRef);
        if (snap.exists()) {
          const data = snap.data();
          document.getElementById('userName').value = data.name || user.displayName || '';
          document.getElementById('userAge').value = data.age || '';
          document.getElementById('userGender').value = data.gender || '';
          document.getElementById('userBio').value = data.bio || '';
          if (data.photoURL) {
            profileImage.src = data.photoURL;
            setProfileIconImage(data.photoURL);
          } else {
            profileImage.src = 'default.png';
            clearProfileIconImage();
          }
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
          displayName.textContent = data.name || user.displayName || 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
          displayAgeGender.textContent = (data.age ? data.age + ' Ø³Ù†Ø©' : 'â€”') + (data.gender ? ' â€¢ ' + data.gender : '');
          displayBio.textContent = data.bio ? 'Ø§Ù„Ù†Ø¨Ø°Ø©: ' + data.bio : 'Ø§Ù„Ù†Ø¨Ø°Ø©: â€”';
        } else {
          // Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª â€” Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
          profileImage.src = 'default.png';
          clearProfileIconImage();
        }
      } catch (err) {
        console.error('load profile error', err);
      }
      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
      loadMessages(user);
    });

    // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ù…Ø¤Ù‚ØªØ§Ù‹
    imageInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      currentPhotoFile = file;
      profileImage.src = URL.createObjectURL(file);
      setProfileIconImage(profileImage.src);
    });

    // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø¹Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ù„Ù
    function setProfileIconImage(src){
      profileIcon.innerHTML = '';
      const img = document.createElement('img');
      img.src = src;
      profileIcon.appendChild(img);
    }
    function clearProfileIconImage(){
      profileIcon.innerHTML = '';
      // Ù†ØªØ±Ùƒ Ø§Ù„Ù„Ù‘ÙˆÙƒÙˆ Ø§Ù„Ø°Ù‡Ø¨ÙŠ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙƒØ®Ù„ÙÙŠØ©
    }

    // Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø¥Ù„Ù‰ Firebase (Storage + Firestore)
    saveBtn.addEventListener('click', async () => {
      if (!currentUser) return alert('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

      try {
        let photoURL = profileImage.src;

        // Ø¥Ø°Ø§ Ø§Ø®ØªØ±Ù†Ø§ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯ØŒ Ù†Ø±ÙØ¹Ù‡ Storage
        if (currentPhotoFile) {
          const storageRef = ref(storage, `profiles/${currentUser.uid}.jpg`);
          await uploadBytes(storageRef, currentPhotoFile);
          photoURL = await getDownloadURL(storageRef);
        } else {
          // Ù„Ùˆ Ø§Ù„ØµÙˆØ±Ø© Ù‡ÙŠ URL Ù…Ø­Ù„ÙŠ Ø£Ùˆ Ø¨Ø§Ù„ÙØ¹Ù„ Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ù†ØªØ±ÙƒÙ‡Ø§ ÙƒÙ…Ø§ Ù‡ÙŠ
          // Ù„ÙƒÙ† Ù„Ùˆ ÙƒØ§Ù†Øª default.png Ù†ØªØ£ÙƒØ¯ Ø¹Ø¯Ù… Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ ÙƒÙ€ URL Ø®Ø§Ø¯Ø¹
          if (photoURL && photoURL.endsWith('default.png')) photoURL = '';
        }

        const name = document.getElementById('userName').value.trim();
        const age = document.getElementById('userAge').value.trim();
        const gender = document.getElementById('userGender').value;
        const bio = document.getElementById('userBio').value.trim();

        // Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙ†Ø¯
        const userDocRef = doc(db, 'users', currentUser.uid);
        await setDoc(userDocRef, {
          name: name || currentUser.displayName || '',
          age: age || '',
          gender: gender || '',
          bio: bio || '',
          photoURL: photoURL || ''
        }, { merge: true });

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙÙˆØ±ÙŠ
        displayName.textContent = name || currentUser.displayName || 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
        displayAgeGender.textContent = (age ? age + ' Ø³Ù†Ø©' : 'â€”') + (gender ? ' â€¢ ' + gender : '');
        displayBio.textContent = bio ? 'Ø§Ù„Ù†Ø¨Ø°Ø©: ' + bio : 'Ø§Ù„Ù†Ø¨Ø°Ø©: â€”';
        if (photoURL) {
          profileImage.src = photoURL;
          setProfileIconImage(photoURL);
        }

        // Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ø£Ù†ÙŠÙ‚Ø©
        successToast.style.display = 'block';
        successToast.textContent = 'âœ… ØªÙ… Ø­ÙØ¸ Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ Ø¨Ù†Ø¬Ø§Ø­!';
        setTimeout(()=> successToast.style.display='none', 2400);

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¤Ù‚Øª
        currentPhotoFile = null;
      } catch (err) {
        console.error('save error', err);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª';
      }
    });

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø­ÙŠØ© Ù…Ù† Firestore
    async function loadMessages(user) {
      const q = query(collection(db,'messages'), orderBy('timestamp','asc'));
      onSnapshot(q, (snapshot)=>{
        messagesDiv.innerHTML = '';
        snapshot.forEach(docSnap=>{
          const d = docSnap.data();
          const div = document.createElement('div');
          div.className = 'msg';
          if (d.user === user.email) div.classList.add('me');
          div.textContent = `${d.user.split('@')[0]}: ${d.text}`;
          messagesDiv.appendChild(div);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
    sendBtn.addEventListener('click', async ()=>{
      const text = messageInput.value.trim();
      if (!text || !currentUser) return;
      await addDoc(collection(db,'messages'), {
        user: currentUser.email,
        text,
        timestamp: serverTimestamp()
      });
      messageInput.value = '';
    });

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    document.getElementById('logoutBtn').addEventListener('click', async ()=>{
      await signOut(auth);
      window.location.href = 'login.html';
    });

    // Ù…Ù†Ø¹ ÙØªØ­ Ø§Ù„Ø¨ÙˆØ¨ Ø§Ø¨ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¯Ø§Ø®Ù„Ù‡ (ØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¥ØºÙ„Ø§Ù‚ Ø®Ø§Ø±Ø¬ÙŠ Ø£Ø¹Ù„Ø§Ù‡)
    profilePopup.addEventListener('click', (e)=> e.stopPropagation());
  </script>
</body>
</html>