<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>👑 شات الملوك — الدردشة والبروفايل 👑</title>
  <style>
    :root{
      --gold1:#ffd700;
      --gold2:#e6b800;
      --gold3:#b8860b;
      --bg:#000;
      --card:#111;
      --muted:#777;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Tajawal",sans-serif;
      background: linear-gradient(180deg, #050505 0%, #0b0b0b 100%);
      color: var(--gold1);
      display:flex;
      align-items:center;
      justify-content:center;
      height:100vh;
      overflow:hidden;
    }

    /* صندوق الشات */
    .chat-box{
      width:94%;
      max-width:980px;
      height:88vh;
      background: linear-gradient(180deg,#0f0f10 0%, #0b0b0b 100%);
      border-radius:14px;
      border:2px solid rgba(212,175,55,0.12);
      box-shadow: 0 8px 40px rgba(0,0,0,0.7), 0 0 30px rgba(212,175,55,0.06) inset;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:18px;
      padding:18px;
      position:relative;
    }

    /* العمود الأيمن (الشات) */
    .chat-area{
      background: linear-gradient(180deg,#070707,#0b0b0b);
      border-radius:10px;
      padding:12px;
      display:flex;
      flex-direction:column;
      border:1px solid rgba(212,175,55,0.06);
    }

    .header{
      background: linear-gradient(90deg,var(--gold2),var(--gold1));
      color:#050505;
      padding:10px;
      border-radius:8px;
      font-weight:700;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      box-shadow: 0 4px 18px rgba(214,170,20,0.15);
    }

    /* أيقونة المستخدم الذهبية ثلاثية الأبعاد */
    .profile-icon{
      position:absolute;
      top:12px;
      left:12px; /* because layout is rtl, left places icon visually on right side of page */
      width:56px;
      height:56px;
      border-radius:50%;
      background: radial-gradient(circle at 30% 30%, var(--gold1), var(--gold2) 55%, var(--gold3));
      box-shadow: 0 6px 22px rgba(214,170,20,0.45), 0 0 30px rgba(214,170,20,0.18) inset;
      border: 2px solid rgba(255,255,255,0.08);
      cursor:pointer;
      transform-style:preserve-3d;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      transition: transform .35s ease, box-shadow .25s ease;
      perspective: 800px;
      z-index:40;
    }

    /* صورة صغيرة على الايقونة إن وُجدت */
    .profile-icon img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    .profile-icon:hover{ transform: rotateY(12deg) scale(1.03); box-shadow:0 10px 40px rgba(214,170,20,0.6); }

    /* العمود الشمالي الأيسر: لوحة المستخدم */
    .side{
      width:100%;
      max-width:320px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .user-card{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:12px;
      padding:14px;
      border:1px solid rgba(212,175,55,0.06);
      box-shadow: 0 6px 18px rgba(0,0,0,0.6);
    }
    .user-card h3{ margin:0 0 6px 0; color:var(--gold1); }
    .user-card p{ margin:6px 0; color:var(--muted); font-size:14px }

    /* منطقة الرسائل */
    #messages{
      flex:1;
      overflow:auto;
      padding:8px;
      border-radius:8px;
      background:linear-gradient(180deg,#020202, #060606);
      border:1px solid rgba(255,255,255,0.02);
      color:var(--gold1);
    }
    .msg{ padding:8px 10px; margin:8px 0; border-radius:10px; background:#111; color:#eee; max-width:75%; }
    .msg.me{ background:var(--gold1); color:#050505; margin-left:auto; text-align:right; }

    .input-area{ display:flex; gap:8px; margin-top:10px; align-items:center }
    .input-area input{ flex:1; padding:10px 12px; border-radius:8px; background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--gold1) }

    .btn{ background:linear-gradient(90deg,var(--gold2),var(--gold1)); color:#050505; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:700 }

    /* نافذة الملف الشخصي (مربعة كلاسيكية) */
    .profile-popup{
      display:none;
      position:absolute;
      top:24px;
      left:calc(100% - 300px); /* تظهر في أعلى اليمين بصندوق فوق الشات */
      width:300px;
      background: linear-gradient(180deg, rgba(20,20,20,0.98), rgba(12,12,12,0.98));
      border-radius:12px;
      border:2px solid rgba(212,175,55,0.15);
      padding:14px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.7), 0 0 30px rgba(212,175,55,0.08) inset;
      z-index:60;
      transform-origin: top right;
      animation: popIn .22s ease;
    }
    @keyframes popIn{
      from{ opacity:0; transform: translateY(-8px) scale(.98) }
      to{ opacity:1; transform: translateY(0) scale(1) }
    }

    .profile-popup .close{
      position:absolute;
      top:8px;
      right:8px; /* لأن الصفحة rtl، right = أعلى يسار للمستخدم بصرياً */
      color:var(--gold1);
      background:transparent;
      border:none;
      font-size:20px;
      cursor:pointer;
    }

    .profile-popup img{
      width:92px; height:92px; object-fit:cover; border-radius:50%;
      border:2px solid rgba(212,175,55,0.9); box-shadow:0 6px 20px rgba(214,170,20,0.18);
      display:block; margin:6px auto 10px;
    }
    .profile-popup input, .profile-popup textarea, .profile-popup select{
      width:100%; padding:8px; margin:6px 0; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:var(--gold1); text-align:center
    }
    .profile-popup textarea{ min-height:64px; resize:vertical }

    .success-toast{
      position:fixed;
      top:20px;
      left:50%;
      transform:translateX(-50%);
      background: linear-gradient(90deg,var(--gold1),var(--gold2));
      color:#050505;
      padding:10px 18px;
      border-radius:12px;
      box-shadow:0 8px 30px rgba(214,170,20,0.25);
      display:none;
      z-index:120;
      font-weight:800;
    }

    /* responsive */
    @media (max-width:900px){
      .chat-box{ grid-template-columns: 1fr; padding:12px; height:94vh;}
      .profile-popup{ left:auto; right:14px; top:16px; width:92%; }
      .profile-icon{ left:12px; top:8px }
    }
  </style>
</head>
<body>

  <div class="chat-box" id="chatBox">
    <!-- العمود الأيسر: بطاقة المستخدم (معلومات سريعة) -->
    <div class="side">
      <div class="user-card">
        <h3 id="displayName">المستخدم</h3>
        <p id="displayEmail">user@example.com</p>
        <p id="displayAgeGender">—</p>
        <p id="displayBio" style="color:var(--muted)">النبذة: —</p>
      </div>
      <div class="user-card">
        <h3>خيارات</h3>
        <button id="openProfileBtn" class="btn" style="width:100%;">فتح الملف الشخصي</button>
        <button id="logoutBtn" class="btn" style="background:crimson;margin-top:10px;color:#fff">تسجيل الخروج</button>
      </div>
    </div>

    <!-- العمود الأيمن: الشات -->
    <div class="chat-area" id="rightArea">
      <div class="header">👑 شات الملوك 👑
        <!-- أيقونة المستخدم الذهبية ثلاثية الأبعاد -->
        <div class="profile-icon" id="profileIcon" title="الملف الشخصي">
          <!-- صورة Avatar ستوضع هنا إذا وُجدت -->
        </div>
      </div>

      <!-- نافذة الملف الشخصي المنبثقة -->
      <div class="profile-popup" id="profilePopup" role="dialog" aria-modal="true">
        <button class="close" id="closePopup">❌</button>
        <img id="profileImage" src="default.png" alt="الصورة الشخصية">
        <input type="file" id="imageInput" accept="image/*" />
        <input type="text" id="userName" placeholder="الاسم" />
        <input type="number" id="userAge" placeholder="العمر" />
        <select id="userGender">
          <option value="">الجنس</option>
          <option value="ذكر">ذكر</option>
          <option value="أنثى">أنثى</option>
        </select>
        <textarea id="userBio" placeholder="نبذة قصيرة..."></textarea>
        <button id="saveBtn" class="btn">💾 حفظ التغييرات</button>
      </div>

      <!-- رسائل -->
      <div id="messages"></div>

      <!-- إرسال -->
      <div class="input-area" style="margin-top:12px">
        <input id="messageInput" placeholder="اكتب رسالتك..." />
        <button id="sendBtn" class="btn">إرسال</button>
      </div>
    </div>
  </div>

  <!-- رسالة النجاح -->
  <div class="success-toast" id="successToast">✅ تم حفظ ملفك الشخصي بنجاح!</div>

  <!-- Firebase & Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-storage.js";

    // ====== ضع هنا إعدادات مشروع Firebase (الموجودة عندك بالفعل) ======
    const firebaseConfig = {
      apiKey: "AIzaSyDJhA1WkFsLZiQz5WZFWPFbdjxLPtG57ss",
      authDomain: "lloo-756f7.firebaseapp.com",
      projectId: "lloo-756f7",
      storageBucket: "lloo-756f7.firebasestorage.app",
      messagingSenderId: "951071688513",
      appId: "1:951071688513:web:46f402720b38f15c5043c0"
    };
    // ===================================================================

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    // عناصر الـ DOM
    const profileIcon = document.getElementById('profileIcon');
    const profilePopup = document.getElementById('profilePopup');
    const openProfileBtn = document.getElementById('openProfileBtn');
    const closePopup = document.getElementById('closePopup');
    const imageInput = document.getElementById('imageInput');
    const profileImage = document.getElementById('profileImage');
    const saveBtn = document.getElementById('saveBtn');
    const successToast = document.getElementById('successToast');

    const displayName = document.getElementById('displayName');
    const displayEmail = document.getElementById('displayEmail');
    const displayAgeGender = document.getElementById('displayAgeGender');
    const displayBio = document.getElementById('displayBio');

    const messagesDiv = document.getElementById('messages');
    const sendBtn = document.getElementById('sendBtn');
    const messageInput = document.getElementById('messageInput');

    let currentUser = null;
    let currentPhotoFile = null;

    // إظهار/إخفاء البوب أب
    function openPopup(){ profilePopup.style.display = 'block'; }
    function closePopupFunc(){ profilePopup.style.display = 'none'; }

    profileIcon.addEventListener('click', openPopup);
    openProfileBtn.addEventListener('click', openPopup);
    closePopup.addEventListener('click', closePopupFunc);

    // إغلاق لو ضغط خارج النافذة
    document.addEventListener('click', (e) => {
      if (!profilePopup.contains(e.target) && !profileIcon.contains(e.target) && profilePopup.style.display==='block'){
        closePopupFunc();
      }
    });

    // تحميل بيانات المستخدم عند تسجيل الدخول
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // لو مو مسجل يرجع للتسجيل
        window.location.href = 'login.html';
        return;
      }
      currentUser = user;
      displayEmail.textContent = user.email || '';
      displayName.textContent = user.displayName || 'المستخدم';
      // جلب بيانات من Firestore
      try {
        const docRef = doc(db, 'users', user.uid);
        const snap = await getDoc(docRef);
        if (snap.exists()) {
          const data = snap.data();
          document.getElementById('userName').value = data.name || user.displayName || '';
          document.getElementById('userAge').value = data.age || '';
          document.getElementById('userGender').value = data.gender || '';
          document.getElementById('userBio').value = data.bio || '';
          if (data.photoURL) {
            profileImage.src = data.photoURL;
            setProfileIconImage(data.photoURL);
          } else {
            profileImage.src = 'default.png';
            clearProfileIconImage();
          }
          // تحديث البطاقة الجانبية
          displayName.textContent = data.name || user.displayName || 'المستخدم';
          displayAgeGender.textContent = (data.age ? data.age + ' سنة' : '—') + (data.gender ? ' • ' + data.gender : '');
          displayBio.textContent = data.bio ? 'النبذة: ' + data.bio : 'النبذة: —';
        } else {
          // لا توجد بيانات — نعرض الاسم الافتراضي
          profileImage.src = 'default.png';
          clearProfileIconImage();
        }
      } catch (err) {
        console.error('load profile error', err);
      }
      // تحميل الرسائل
      loadMessages(user);
    });

    // عند اختيار صورة مؤقتاً
    imageInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      currentPhotoFile = file;
      profileImage.src = URL.createObjectURL(file);
      setProfileIconImage(profileImage.src);
    });

    // دالة لعرض الصورة على أيقونة الملف
    function setProfileIconImage(src){
      profileIcon.innerHTML = '';
      const img = document.createElement('img');
      img.src = src;
      profileIcon.appendChild(img);
    }
    function clearProfileIconImage(){
      profileIcon.innerHTML = '';
      // نترك اللّوكو الذهبي الافتراضي كخلفية
    }

    // حفظ الملف الشخصي إلى Firebase (Storage + Firestore)
    saveBtn.addEventListener('click', async () => {
      if (!currentUser) return alert('المستخدم غير موجود');
      saveBtn.disabled = true;
      saveBtn.textContent = 'جاري الحفظ...';

      try {
        let photoURL = profileImage.src;

        // إذا اخترنا ملف جديد، نرفعه Storage
        if (currentPhotoFile) {
          const storageRef = ref(storage, `profiles/${currentUser.uid}.jpg`);
          await uploadBytes(storageRef, currentPhotoFile);
          photoURL = await getDownloadURL(storageRef);
        } else {
          // لو الصورة هي URL محلي أو بالفعل موجودة، نتركها كما هي
          // لكن لو كانت default.png نتأكد عدم إرسالها كـ URL خادع
          if (photoURL && photoURL.endsWith('default.png')) photoURL = '';
        }

        const name = document.getElementById('userName').value.trim();
        const age = document.getElementById('userAge').value.trim();
        const gender = document.getElementById('userGender').value;
        const bio = document.getElementById('userBio').value.trim();

        // حفظ المستند
        const userDocRef = doc(db, 'users', currentUser.uid);
        await setDoc(userDocRef, {
          name: name || currentUser.displayName || '',
          age: age || '',
          gender: gender || '',
          bio: bio || '',
          photoURL: photoURL || ''
        }, { merge: true });

        // تحديث العرض الفوري
        displayName.textContent = name || currentUser.displayName || 'المستخدم';
        displayAgeGender.textContent = (age ? age + ' سنة' : '—') + (gender ? ' • ' + gender : '');
        displayBio.textContent = bio ? 'النبذة: ' + bio : 'النبذة: —';
        if (photoURL) {
          profileImage.src = photoURL;
          setProfileIconImage(photoURL);
        }

        // رسالة نجاح أنيقة
        successToast.style.display = 'block';
        successToast.textContent = '✅ تم حفظ ملفك الشخصي بنجاح!';
        setTimeout(()=> successToast.style.display='none', 2400);

        // إعادة تعيين الملف المؤقت
        currentPhotoFile = null;
      } catch (err) {
        console.error('save error', err);
        alert('حدث خطأ أثناء الحفظ، حاول مرة أخرى.');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = '💾 حفظ التغييرات';
      }
    });

    // تحميل الرسائل الحية من Firestore
    async function loadMessages(user) {
      const q = query(collection(db,'messages'), orderBy('timestamp','asc'));
      onSnapshot(q, (snapshot)=>{
        messagesDiv.innerHTML = '';
        snapshot.forEach(docSnap=>{
          const d = docSnap.data();
          const div = document.createElement('div');
          div.className = 'msg';
          if (d.user === user.email) div.classList.add('me');
          div.textContent = `${d.user.split('@')[0]}: ${d.text}`;
          messagesDiv.appendChild(div);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
    }

    // إرسال رسالة
    sendBtn.addEventListener('click', async ()=>{
      const text = messageInput.value.trim();
      if (!text || !currentUser) return;
      await addDoc(collection(db,'messages'), {
        user: currentUser.email,
        text,
        timestamp: serverTimestamp()
      });
      messageInput.value = '';
    });

    // تسجيل الخروج
    document.getElementById('logoutBtn').addEventListener('click', async ()=>{
      await signOut(auth);
      window.location.href = 'login.html';
    });

    // منع فتح البوب اب عند الضغط داخله (تم التعامل مع إغلاق خارجي أعلاه)
    profilePopup.addEventListener('click', (e)=> e.stopPropagation());
  </script>
</body>
</html>