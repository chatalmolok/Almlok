<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ‘‘ Ø´Ø§Øª Ø§Ù„Ù…Ù„ÙˆÙƒ â€” Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ÙˆØ§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ğŸ‘‘</title>
  <style>
    :root{
      --gold1:#ffd700;
      --gold2:#e6b800;
      --gold3:#b8860b;
      --bg:#000;
      --card:#111;
      --muted:#777;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Tajawal",sans-serif;
      background: linear-gradient(180deg, #050505 0%, #0b0b0b 100%);
      color: var(--gold1);
      display:flex;
      align-items:center;
      justify-content:center;
      height:100vh;
      overflow:hidden;
    }

    /* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø´Ø§Øª */
    .chat-box{
      width:94%;
      max-width:980px;
      height:88vh;
      background: linear-gradient(180deg,#0f0f10 0%, #0b0b0b 100%);
      border-radius:14px;
      border:2px solid rgba(212,175,55,0.12);
      box-shadow: 0 8px 40px rgba(0,0,0,0.7), 0 0 30px rgba(212,175,55,0.06) inset;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:18px;
      padding:18px;
      position:relative;
      transition: all .35s ease;
    }

    /* Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠÙ…Ù† (Ø§Ù„Ø´Ø§Øª) */
    .chat-area{
      background: linear-gradient(180deg,#070707,#0b0b0b);
      border-radius:10px;
      padding:12px;
      display:flex;
      flex-direction:column;
      border:1px solid rgba(212,175,55,0.06);
      position:relative;
      overflow:hidden;
    }

    .header{
      background: linear-gradient(90deg,var(--gold2),var(--gold1));
      color:#050505;
      padding:10px;
      border-radius:8px;
      font-weight:700;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      box-shadow: 0 4px 18px rgba(214,170,20,0.15);
    }

    /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ */
    .profile-icon{
      position:absolute;
      top:12px;
      left:12px; /* Ù„Ø£Ù† Ø§Ù„ØµÙØ­Ø© rtlØŒ left ÙŠÙƒÙˆÙ† Ø¹Ù„Ù‰ ÙŠÙ…ÙŠÙ† Ø§Ù„Ø´Ø§Ø´Ø© Ø¨ØµØ±ÙŠÙ‹Ø§ */
      width:56px;
      height:56px;
      border-radius:50%;
      background: radial-gradient(circle at 30% 30%, var(--gold1), var(--gold2) 55%, var(--gold3));
      box-shadow: 0 6px 22px rgba(214,170,20,0.45), 0 0 30px rgba(214,170,20,0.18) inset;
      border: 2px solid rgba(255,255,255,0.08);
      cursor:pointer;
      transform-style:preserve-3d;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      transition: transform .35s ease, box-shadow .25s ease;
      perspective: 800px;
      z-index:40;
    }

    .profile-icon img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    .profile-icon:hover{ transform: rotateY(12deg) scale(1.03); box-shadow:0 10px 40px rgba(214,170,20,0.6); }

    /* Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠØ³Ø±: Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
    .side{
      width:100%;
      max-width:320px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .user-card{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:12px;
      padding:14px;
      border:1px solid rgba(212,175,55,0.06);
      box-shadow: 0 6px 18px rgba(0,0,0,0.6);
    }
    .user-card h3{ margin:0 0 6px 0; color:var(--gold1); }
    .user-card p{ margin:6px 0; color:var(--muted); font-size:14px }

    /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
    #messages{
      flex:1;
      overflow:auto;
      padding:8px;
      border-radius:8px;
      background:linear-gradient(180deg,#020202, #060606);
      border:1px solid rgba(255,255,255,0.02);
      color:var(--gold1);
    }
    .msg{ padding:8px 10px; margin:8px 0; border-radius:10px; background:#111; color:#eee; max-width:75%; }
    .msg.me{ background:var(--gold1); color:#050505; margin-left:auto; text-align:right; }

    .input-area{ display:flex; gap:8px; margin-top:10px; align-items:center }
    .input-area input{ flex:1; padding:10px 12px; border-radius:8px; background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--gold1) }

    .btn{ background:linear-gradient(90deg,var(--gold2),var(--gold1)); color:#050505; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:700 }

    /* ØµÙØ­Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ (ÙØ±Ø¹ÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø§Øª) */
    .profile-page{
      position:absolute;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background: linear-gradient(180deg,#080707, #050404);
      z-index:80;
      transform: translateX(100%);
      transition: transform .45s cubic-bezier(.2,.9,.25,1);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }

    .profile-card{
      width:540px;
      max-width:95%;
      background: linear-gradient(180deg,#0f0f0f,#090909);
      border-radius:12px;
      border:2px solid rgba(212,175,55,0.16);
      padding:20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.7);
    }

    .profile-card .top{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }

    .profile-card img{
      width:110px; height:110px; object-fit:cover; border-radius:50%;
      border:3px solid rgba(212,175,55,0.95); box-shadow:0 6px 30px rgba(214,170,20,0.18);
    }

    .profile-card input, .profile-card textarea, .profile-card select{
      width:100%; padding:10px; margin-top:8px; border-radius:8px; background:transparent; color:var(--gold1); border:1px solid rgba(255,255,255,0.03); text-align:center;
    }
    .profile-card textarea{ min-height:100px; resize:vertical }

    .profile-actions{ display:flex; gap:10px; margin-top:12px; align-items:center; justify-content:flex-end }
    .back-btn{ background:transparent; color:var(--gold1); border:1px solid rgba(255,255,255,0.04); padding:8px 12px; border-radius:8px; cursor:pointer }
    .save-btn{ background:linear-gradient(90deg,var(--gold2),var(--gold1)); color:#050505; padding:8px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:800 }

    .close-small{ background:transparent; border:none; color:var(--gold1); font-size:20px; cursor:pointer; position:absolute; top:12px; left:12px }

    .success-toast{
      position:fixed;
      top:18px;
      left:50%;
      transform:translateX(-50%);
      background: linear-gradient(90deg,var(--gold1),var(--gold2));
      color:#050505;
      padding:10px 18px;
      border-radius:12px;
      box-shadow:0 8px 30px rgba(214,170,20,0.25);
      display:none;
      z-index:120;
      font-weight:800;
    }

    /* responsive */
    @media (max-width:900px){
      .chat-box{ grid-template-columns: 1fr; height:94vh; padding:12px; }
      .profile-card{ width:100%; }
      .profile-page{ padding:10px; }
      .profile-icon{ left:12px; top:8px }
    }
  </style>
</head>
<body>

  <div class="chat-box" id="chatBox">
    <!-- Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠØ³Ø±: Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø³Ø±ÙŠØ¹Ø©) -->
    <div class="side">
      <div class="user-card">
        <h3 id="displayName">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
        <p id="displayEmail">user@example.com</p>
        <p id="displayAgeGender">â€”</p>
        <p id="displayBio" style="color:var(--muted)">Ø§Ù„Ù†Ø¨Ø°Ø©: â€”</p>
      </div>
      <div class="user-card">
        <h3>Ø®ÙŠØ§Ø±Ø§Øª</h3>
        <button id="openProfileBtn" class="btn" style="width:100%;">ÙØªØ­ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</button>
        <button id="logoutBtn" class="btn" style="background:crimson;margin-top:10px;color:#fff">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>

    <!-- Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠÙ…Ù†: Ø§Ù„Ø´Ø§Øª -->
    <div class="chat-area" id="rightArea">
      <div class="header">ğŸ‘‘ Ø´Ø§Øª Ø§Ù„Ù…Ù„ÙˆÙƒ ğŸ‘‘
        <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ -->
        <div class="profile-icon" id="profileIcon" title="Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ">
          <!-- ØµÙˆØ±Ø© Avatar Ø³ØªÙˆØ¶Ø¹ Ù‡Ù†Ø§ Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯Øª -->
        </div>
      </div>

      <!-- Ø±Ø³Ø§Ø¦Ù„ -->
      <div id="messages"></div>

      <!-- Ø¥Ø±Ø³Ø§Ù„ -->
      <div class="input-area" style="margin-top:12px">
        <input id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." />
        <button id="sendBtn" class="btn">Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
    </div>

    <!-- ØµÙØ­Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„ÙØ±Ø¹ÙŠØ© (Ù…Ø®ÙÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹) -->
    <div class="profile-page" id="profilePage" aria-hidden="true">
      <div class="profile-card" role="dialog" aria-modal="true">
        <button class="close-small" id="closeProfileX">âŒ</button>
        <div class="top">
          <div style="flex:1">
            <img id="profileLarge" src="default.png" alt="Ø§Ù„ØµÙˆØ±Ø©">
            <input type="file" id="profileFile" accept="image/*" />
          </div>
          <div style="flex:1">
            <input type="text" id="pName" placeholder="Ø§Ù„Ø§Ø³Ù…" />
            <input type="number" id="pAge" placeholder="Ø§Ù„Ø¹Ù…Ø±" />
            <select id="pGender">
              <option value="">Ø§Ù„Ø¬Ù†Ø³</option>
              <option value="Ø°ÙƒØ±">Ø°ÙƒØ±</option>
              <option value="Ø£Ù†Ø«Ù‰">Ø£Ù†Ø«Ù‰</option>
            </select>
          </div>
        </div>

        <textarea id="pBio" placeholder="Ù†Ø¨Ø°Ø© Ù‚ØµÙŠØ±Ø© Ø¹Ù†Ùƒ..."></textarea>

        <div class="profile-actions">
          <button class="back-btn" id="backToChat">â¬…ï¸ Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Øª</button>
          <button class="save-btn" id="saveProfileBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
        </div>
      </div>
    </div>

  </div>

  <!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ -->
  <div class="success-toast" id="successToast">âœ… ØªÙ… Ø­ÙØ¸ Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ Ø¨Ù†Ø¬Ø§Ø­!</div>

  <!-- Firebase & Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-storage.js";

    // ====== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (Ø§Ø³ØªØ¹Ù…Ù„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø³Ø§Ø¨Ù‚Ù‹Ø§) ======
    const firebaseConfig = {
      apiKey: "AIzaSyDJhA1WkFsLZiQz5WZFWPFbdjxLPtG57ss",
      authDomain: "lloo-756f7.firebaseapp.com",
      projectId: "lloo-756f7",
      storageBucket: "lloo-756f7.firebasestorage.app",
      messagingSenderId: "951071688513",
      appId: "1:951071688513:web:46f402720b38f15c5043c0"
    };
    // ======================================================================

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    // Ø¹Ù†Ø§ØµØ± DOM
    const profileIcon = document.getElementById('profileIcon');
    const profilePage = document.getElementById('profilePage');
    const openProfileBtn = document.getElementById('openProfileBtn');
    const closeProfileX = document.getElementById('closeProfileX');
    const profileFile = document.getElementById('profileFile');
    const profileLarge = document.getElementById('profileLarge');
    const saveProfileBtn = document.getElementById('saveProfileBtn');
    const backToChat = document.getElementById('backToChat');
    const successToast = document.getElementById('successToast');

    const displayName = document.getElementById('displayName');
    const displayEmail = document.getElementById('displayEmail');
    const displayAgeGender = document.getElementById('displayAgeGender');
    const displayBio = document.getElementById('displayBio');

    const messagesDiv = document.getElementById('messages');
    const sendBtn = document.getElementById('sendBtn');
    const messageInput = document.getElementById('messageInput');

    let currentUser = null;
    let tempPhotoFile = null;

    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø´Ø§Øª ÙˆØ§Ù„ØµÙØ­Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ©
    function showProfilePage(){
      // Ø§Ù†Ø²Ø§Ø­ Ø§Ù„Ø´Ø§Øª: Ù†Ø­Ø±Ùƒ profilePage Ù„Ø¥Ø¸Ù‡Ø§Ø±Ù‡Ø§
      profilePage.style.transform = 'translateX(0)';
      profilePage.setAttribute('aria-hidden','false');
    }
    function hideProfilePage(){
      profilePage.style.transform = 'translateX(100%)';
      profilePage.setAttribute('aria-hidden','true');
    }

    profileIcon.addEventListener('click', showProfilePage);
    openProfileBtn.addEventListener('click', showProfilePage);
    closeProfileX.addEventListener('click', hideProfilePage);
    backToChat.addEventListener('click', hideProfilePage);

    // Ø¥ØºÙ„Ø§Ù‚ Ù„Ùˆ Ø¶ØºØ· Ø®Ø§Ø±Ø¬ (Ø®Ù„ÙŠÙ‡Ø§ Ø¨Ø³ÙŠØ·Ø© â€” Ù„ÙƒÙ† Ø¨Ù…Ø§ Ø§Ù†Ù‡ ØµÙØ­Ø© ÙØ±Ø¹ÙŠÙ‡ Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„Ù…Ù„ÙØŒ Ù„Ø§ Ù†ØºÙ„Ù‚ Ù„Ùˆ Ø¶ØºØ· Ø®Ø§Ø±Ø¬)
    document.addEventListener('keydown', (e)=> {
      if (e.key === 'Escape') hideProfilePage();
    });

    // Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      currentUser = user;
      displayEmail.textContent = user.email || '';
      displayName.textContent = user.displayName || 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';

      try {
        const userDoc = doc(db, 'users', user.uid);
        const snap = await getDoc(userDoc);
        if (snap.exists()) {
          const data = snap.data();
          document.getElementById('pName').value = data.name || user.displayName || '';
          document.getElementById('pAge').value = data.age || '';
          document.getElementById('pGender').value = data.gender || '';
          document.getElementById('pBio').value = data.bio || '';
          if (data.photoURL) {
            profileLarge.src = data.photoURL;
            setIconImage(data.photoURL);
          } else {
            profileLarge.src = 'default.png';
            clearIconImage();
          }
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
          displayName.textContent = data.name || user.displayName || 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
          displayAgeGender.textContent = (data.age ? data.age + ' Ø³Ù†Ø©' : 'â€”') + (data.gender ? ' â€¢ ' + data.gender : '');
          displayBio.textContent = data.bio ? 'Ø§Ù„Ù†Ø¨Ø°Ø©: ' + data.bio : 'Ø§Ù„Ù†Ø¨Ø°Ø©: â€”';
        } else {
          profileLarge.src = 'default.png';
          clearIconImage();
        }
      } catch (err) {
        console.error('load profile error', err);
      }

      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø­ÙŠØ©
      loadMessages(user);
    });

    // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© (Ø¹Ø±Ø¶ ÙÙˆØ±ÙŠ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸)
    profileFile.addEventListener('change', (e)=>{
      const f = e.target.files[0];
      if (!f) return;
      tempPhotoFile = f;
      profileLarge.src = URL.createObjectURL(f);
      setIconImage(profileLarge.src);
    });

    function setIconImage(src){
      profileIcon.innerHTML = '';
      const img = document.createElement('img');
      img.src = src;
      profileIcon.appendChild(img);
    }
    function clearIconImage(){
      profileIcon.innerHTML = '';
    }

    // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù„Ù„Ù€ Firestore + Storage Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ¶ØºØ· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø²Ø± Ø­ÙØ¸
    saveProfileBtn.addEventListener('click', async ()=>{
      if (!currentUser) return alert('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
      saveProfileBtn.disabled = true;
      saveProfileBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

      try {
        let photoURL = '';
        // Ø¥Ø°Ø§ Ø§Ø®ØªØ± Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯ØŒ Ø§Ø±ÙØ¹Ù‡ Ù„Ù„Ù€ Storage
        if (tempPhotoFile) {
          const storageRef = ref(storage, `profiles/${currentUser.uid}.jpg`);
          await uploadBytes(storageRef, tempPhotoFile);
          photoURL = await getDownloadURL(storageRef);
        } else {
          // Ø§Ø­ØªÙØ¸ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ù‹Ø§ ÙÙŠ src Ø§Ù„ØµÙˆØ±Ø©
          if (profileLarge.src && !profileLarge.src.endsWith('default.png')) photoURL = profileLarge.src;
        }

        const name = document.getElementById('pName').value.trim();
        const age = document.getElementById('pAge').value.trim();
        const gender = document.getElementById('pGender').value;
        const bio = document.getElementById('pBio').value.trim();

        const userDocRef = doc(db, 'users', currentUser.uid);
        await setDoc(userDocRef, {
          name: name || currentUser.displayName || '',
          age: age || '',
          gender: gender || '',
          bio: bio || '',
          photoURL: photoURL || ''
        }, { merge: true });

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙÙˆØ±ÙŠ ÙÙŠ Ø§Ù„Ø´Ø§Øª
        displayName.textContent = name || currentUser.displayName || 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
        displayAgeGender.textContent = (age ? age + ' Ø³Ù†Ø©' : 'â€”') + (gender ? ' â€¢ ' + gender : '');
        displayBio.textContent = bio ? 'Ø§Ù„Ù†Ø¨Ø°Ø©: ' + bio : 'Ø§Ù„Ù†Ø¨Ø°Ø©: â€”';
        if (photoURL) { profileLarge.src = photoURL; setIconImage(photoURL); }

        // Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ù…Ù„ÙƒÙŠØ©
        successToast.style.display = 'block';
        successToast.textContent = 'âœ… ØªÙ… Ø­ÙØ¸ Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ Ø¨Ù†Ø¬Ø§Ø­!';
        setTimeout(()=> successToast.style.display='none', 2500);

        tempPhotoFile = null;
      } catch (err) {
        console.error('save profile error', err);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
      } finally {
        saveProfileBtn.disabled = false;
        saveProfileBtn.textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª';
      }
    });

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Firestore
    async function loadMessages(user){
      const q = query(collection(db,'messages'), orderBy('timestamp','asc'));
      onSnapshot(q, (snapshot)=>{
        messagesDiv.innerHTML = '';
        snapshot.forEach(snap=>{
          const d = snap.data();
          const div = document.createElement('div');
          div.className = 'msg';
          if (d.user === user.email) div.classList.add('me');
          div.textContent = `${d.user.split('@')[0]}: ${d.text}`;
          messagesDiv.appendChild(div);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
    sendBtn.addEventListener('click', async ()=>{
      const text = messageInput.value.trim();
      if (!text || !currentUser) return;
      await addDoc(collection(db,'messages'), {
        user: currentUser.email,
        text,
        timestamp: serverTimestamp()
      });
      messageInput.value = '';
    });

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    document.getElementById('logoutBtn').addEventListener('click', async ()=>{
      await signOut(auth);
      window.location.href = 'login.html';
    });

    // Ù…Ù†Ø¹ Ø§Ù„Ø¨ÙˆØ¨ Ø§Ø¨ Ù…Ù† Ø§Ù„ØºÙ„Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¯Ø§Ø®Ù„Ù‡
    document.getElementById('profilePage').addEventListener('click', (e)=> e.stopPropagation());
  </script>
</body>
</html>