<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>👑 شات الملوك — الدردشة والبروفايل 👑</title>
  <style>
    :root{
      --gold1:#ffd700;
      --gold2:#e6b800;
      --gold3:#b8860b;
      --bg:#000;
      --card:#111;
      --muted:#777;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Tajawal",sans-serif;
      background: linear-gradient(180deg, #050505 0%, #0b0b0b 100%);
      color: var(--gold1);
      display:flex;
      align-items:center;
      justify-content:center;
      height:100vh;
      overflow:hidden;
    }

    /* صندوق الشات */
    .chat-box{
      width:94%;
      max-width:980px;
      height:88vh;
      background: linear-gradient(180deg,#0f0f10 0%, #0b0b0b 100%);
      border-radius:14px;
      border:2px solid rgba(212,175,55,0.12);
      box-shadow: 0 8px 40px rgba(0,0,0,0.7), 0 0 30px rgba(212,175,55,0.06) inset;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:18px;
      padding:18px;
      position:relative;
      transition: all .35s ease;
    }

    /* العمود الأيمن (الشات) */
    .chat-area{
      background: linear-gradient(180deg,#070707,#0b0b0b);
      border-radius:10px;
      padding:12px;
      display:flex;
      flex-direction:column;
      border:1px solid rgba(212,175,55,0.06);
      position:relative;
      overflow:hidden;
    }

    .header{
      background: linear-gradient(90deg,var(--gold2),var(--gold1));
      color:#050505;
      padding:10px;
      border-radius:8px;
      font-weight:700;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      box-shadow: 0 4px 18px rgba(214,170,20,0.15);
    }

    /* أيقونة المستخدم الذهبية ثلاثية الأبعاد */
    .profile-icon{
      position:absolute;
      top:12px;
      left:12px; /* لأن الصفحة rtl، left يكون على يمين الشاشة بصريًا */
      width:56px;
      height:56px;
      border-radius:50%;
      background: radial-gradient(circle at 30% 30%, var(--gold1), var(--gold2) 55%, var(--gold3));
      box-shadow: 0 6px 22px rgba(214,170,20,0.45), 0 0 30px rgba(214,170,20,0.18) inset;
      border: 2px solid rgba(255,255,255,0.08);
      cursor:pointer;
      transform-style:preserve-3d;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      transition: transform .35s ease, box-shadow .25s ease;
      perspective: 800px;
      z-index:40;
    }

    .profile-icon img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    .profile-icon:hover{ transform: rotateY(12deg) scale(1.03); box-shadow:0 10px 40px rgba(214,170,20,0.6); }

    /* العمود الأيسر: لوحة المستخدم */
    .side{
      width:100%;
      max-width:320px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .user-card{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:12px;
      padding:14px;
      border:1px solid rgba(212,175,55,0.06);
      box-shadow: 0 6px 18px rgba(0,0,0,0.6);
    }
    .user-card h3{ margin:0 0 6px 0; color:var(--gold1); }
    .user-card p{ margin:6px 0; color:var(--muted); font-size:14px }

    /* منطقة الرسائل */
    #messages{
      flex:1;
      overflow:auto;
      padding:8px;
      border-radius:8px;
      background:linear-gradient(180deg,#020202, #060606);
      border:1px solid rgba(255,255,255,0.02);
      color:var(--gold1);
    }
    .msg{ padding:8px 10px; margin:8px 0; border-radius:10px; background:#111; color:#eee; max-width:75%; }
    .msg.me{ background:var(--gold1); color:#050505; margin-left:auto; text-align:right; }

    .input-area{ display:flex; gap:8px; margin-top:10px; align-items:center }
    .input-area input{ flex:1; padding:10px 12px; border-radius:8px; background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--gold1) }

    .btn{ background:linear-gradient(90deg,var(--gold2),var(--gold1)); color:#050505; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:700 }

    /* صفحة الملف الشخصي (فرعية داخل الشات) */
    .profile-page{
      position:absolute;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background: linear-gradient(180deg,#080707, #050404);
      z-index:80;
      transform: translateX(100%);
      transition: transform .45s cubic-bezier(.2,.9,.25,1);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }

    .profile-card{
      width:540px;
      max-width:95%;
      background: linear-gradient(180deg,#0f0f0f,#090909);
      border-radius:12px;
      border:2px solid rgba(212,175,55,0.16);
      padding:20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.7);
    }

    .profile-card .top{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }

    .profile-card img{
      width:110px; height:110px; object-fit:cover; border-radius:50%;
      border:3px solid rgba(212,175,55,0.95); box-shadow:0 6px 30px rgba(214,170,20,0.18);
    }

    .profile-card input, .profile-card textarea, .profile-card select{
      width:100%; padding:10px; margin-top:8px; border-radius:8px; background:transparent; color:var(--gold1); border:1px solid rgba(255,255,255,0.03); text-align:center;
    }
    .profile-card textarea{ min-height:100px; resize:vertical }

    .profile-actions{ display:flex; gap:10px; margin-top:12px; align-items:center; justify-content:flex-end }
    .back-btn{ background:transparent; color:var(--gold1); border:1px solid rgba(255,255,255,0.04); padding:8px 12px; border-radius:8px; cursor:pointer }
    .save-btn{ background:linear-gradient(90deg,var(--gold2),var(--gold1)); color:#050505; padding:8px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:800 }

    .close-small{ background:transparent; border:none; color:var(--gold1); font-size:20px; cursor:pointer; position:absolute; top:12px; left:12px }

    .success-toast{
      position:fixed;
      top:18px;
      left:50%;
      transform:translateX(-50%);
      background: linear-gradient(90deg,var(--gold1),var(--gold2));
      color:#050505;
      padding:10px 18px;
      border-radius:12px;
      box-shadow:0 8px 30px rgba(214,170,20,0.25);
      display:none;
      z-index:120;
      font-weight:800;
    }

    /* responsive */
    @media (max-width:900px){
      .chat-box{ grid-template-columns: 1fr; height:94vh; padding:12px; }
      .profile-card{ width:100%; }
      .profile-page{ padding:10px; }
      .profile-icon{ left:12px; top:8px }
    }
  </style>
</head>
<body>

  <div class="chat-box" id="chatBox">
    <!-- العمود الأيسر: بطاقة المستخدم (معلومات سريعة) -->
    <div class="side">
      <div class="user-card">
        <h3 id="displayName">المستخدم</h3>
        <p id="displayEmail">user@example.com</p>
        <p id="displayAgeGender">—</p>
        <p id="displayBio" style="color:var(--muted)">النبذة: —</p>
      </div>
      <div class="user-card">
        <h3>خيارات</h3>
        <button id="openProfileBtn" class="btn" style="width:100%;">فتح الملف الشخصي</button>
        <button id="logoutBtn" class="btn" style="background:crimson;margin-top:10px;color:#fff">تسجيل الخروج</button>
      </div>
    </div>

    <!-- العمود الأيمن: الشات -->
    <div class="chat-area" id="rightArea">
      <div class="header">👑 شات الملوك 👑
        <!-- أيقونة المستخدم الذهبية ثلاثية الأبعاد -->
        <div class="profile-icon" id="profileIcon" title="الملف الشخصي">
          <!-- صورة Avatar ستوضع هنا إذا وُجدت -->
        </div>
      </div>

      <!-- رسائل -->
      <div id="messages"></div>

      <!-- إرسال -->
      <div class="input-area" style="margin-top:12px">
        <input id="messageInput" placeholder="اكتب رسالتك..." />
        <button id="sendBtn" class="btn">إرسال</button>
      </div>
    </div>

    <!-- صفحة الملف الشخصي الفرعية (مخفية افتراضياً) -->
    <div class="profile-page" id="profilePage" aria-hidden="true">
      <div class="profile-card" role="dialog" aria-modal="true">
        <button class="close-small" id="closeProfileX">❌</button>
        <div class="top">
          <div style="flex:1">
            <img id="profileLarge" src="default.png" alt="الصورة">
            <input type="file" id="profileFile" accept="image/*" />
          </div>
          <div style="flex:1">
            <input type="text" id="pName" placeholder="الاسم" />
            <input type="number" id="pAge" placeholder="العمر" />
            <select id="pGender">
              <option value="">الجنس</option>
              <option value="ذكر">ذكر</option>
              <option value="أنثى">أنثى</option>
            </select>
          </div>
        </div>

        <textarea id="pBio" placeholder="نبذة قصيرة عنك..."></textarea>

        <div class="profile-actions">
          <button class="back-btn" id="backToChat">⬅️ رجوع إلى الشات</button>
          <button class="save-btn" id="saveProfileBtn">💾 حفظ التغييرات</button>
        </div>
      </div>
    </div>

  </div>

  <!-- رسالة النجاح -->
  <div class="success-toast" id="successToast">✅ تم حفظ ملفك الشخصي بنجاح!</div>

  <!-- Firebase & Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-storage.js";

    // ====== إعدادات Firebase (استعمل إعدادات مشروعك الموجودة سابقًا) ======
    const firebaseConfig = {
      apiKey: "AIzaSyDJhA1WkFsLZiQz5WZFWPFbdjxLPtG57ss",
      authDomain: "lloo-756f7.firebaseapp.com",
      projectId: "lloo-756f7",
      storageBucket: "lloo-756f7.firebasestorage.app",
      messagingSenderId: "951071688513",
      appId: "1:951071688513:web:46f402720b38f15c5043c0"
    };
    // ======================================================================

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    // عناصر DOM
    const profileIcon = document.getElementById('profileIcon');
    const profilePage = document.getElementById('profilePage');
    const openProfileBtn = document.getElementById('openProfileBtn');
    const closeProfileX = document.getElementById('closeProfileX');
    const profileFile = document.getElementById('profileFile');
    const profileLarge = document.getElementById('profileLarge');
    const saveProfileBtn = document.getElementById('saveProfileBtn');
    const backToChat = document.getElementById('backToChat');
    const successToast = document.getElementById('successToast');

    const displayName = document.getElementById('displayName');
    const displayEmail = document.getElementById('displayEmail');
    const displayAgeGender = document.getElementById('displayAgeGender');
    const displayBio = document.getElementById('displayBio');

    const messagesDiv = document.getElementById('messages');
    const sendBtn = document.getElementById('sendBtn');
    const messageInput = document.getElementById('messageInput');

    let currentUser = null;
    let tempPhotoFile = null;

    // وظائف التنقل بين الشات والصفحة الفرعية
    function showProfilePage(){
      // انزاح الشات: نحرك profilePage لإظهارها
      profilePage.style.transform = 'translateX(0)';
      profilePage.setAttribute('aria-hidden','false');
    }
    function hideProfilePage(){
      profilePage.style.transform = 'translateX(100%)';
      profilePage.setAttribute('aria-hidden','true');
    }

    profileIcon.addEventListener('click', showProfilePage);
    openProfileBtn.addEventListener('click', showProfilePage);
    closeProfileX.addEventListener('click', hideProfilePage);
    backToChat.addEventListener('click', hideProfilePage);

    // إغلاق لو ضغط خارج (خليها بسيطة — لكن بما انه صفحة فرعيه داخل نفس الملف، لا نغلق لو ضغط خارج)
    document.addEventListener('keydown', (e)=> {
      if (e.key === 'Escape') hideProfilePage();
    });

    // قراءة بيانات المستخدم عند تسجيل الدخول
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      currentUser = user;
      displayEmail.textContent = user.email || '';
      displayName.textContent = user.displayName || 'المستخدم';

      try {
        const userDoc = doc(db, 'users', user.uid);
        const snap = await getDoc(userDoc);
        if (snap.exists()) {
          const data = snap.data();
          document.getElementById('pName').value = data.name || user.displayName || '';
          document.getElementById('pAge').value = data.age || '';
          document.getElementById('pGender').value = data.gender || '';
          document.getElementById('pBio').value = data.bio || '';
          if (data.photoURL) {
            profileLarge.src = data.photoURL;
            setIconImage(data.photoURL);
          } else {
            profileLarge.src = 'default.png';
            clearIconImage();
          }
          // تحديث البطاقة الجانبية
          displayName.textContent = data.name || user.displayName || 'المستخدم';
          displayAgeGender.textContent = (data.age ? data.age + ' سنة' : '—') + (data.gender ? ' • ' + data.gender : '');
          displayBio.textContent = data.bio ? 'النبذة: ' + data.bio : 'النبذة: —';
        } else {
          profileLarge.src = 'default.png';
          clearIconImage();
        }
      } catch (err) {
        console.error('load profile error', err);
      }

      // تحميل الرسائل الحية
      loadMessages(user);
    });

    // رفع الصورة (عرض فوري في الصفحة قبل الحفظ)
    profileFile.addEventListener('change', (e)=>{
      const f = e.target.files[0];
      if (!f) return;
      tempPhotoFile = f;
      profileLarge.src = URL.createObjectURL(f);
      setIconImage(profileLarge.src);
    });

    function setIconImage(src){
      profileIcon.innerHTML = '';
      const img = document.createElement('img');
      img.src = src;
      profileIcon.appendChild(img);
    }
    function clearIconImage(){
      profileIcon.innerHTML = '';
    }

    // حفظ التغييرات للـ Firestore + Storage عندما يضغط المستخدم زر حفظ
    saveProfileBtn.addEventListener('click', async ()=>{
      if (!currentUser) return alert('المستخدم غير موجود');
      saveProfileBtn.disabled = true;
      saveProfileBtn.textContent = 'جاري الحفظ...';

      try {
        let photoURL = '';
        // إذا اختر ملف جديد، ارفعه للـ Storage
        if (tempPhotoFile) {
          const storageRef = ref(storage, `profiles/${currentUser.uid}.jpg`);
          await uploadBytes(storageRef, tempPhotoFile);
          photoURL = await getDownloadURL(storageRef);
        } else {
          // احتفظ إذا كانت موجودة مسبقًا في src الصورة
          if (profileLarge.src && !profileLarge.src.endsWith('default.png')) photoURL = profileLarge.src;
        }

        const name = document.getElementById('pName').value.trim();
        const age = document.getElementById('pAge').value.trim();
        const gender = document.getElementById('pGender').value;
        const bio = document.getElementById('pBio').value.trim();

        const userDocRef = doc(db, 'users', currentUser.uid);
        await setDoc(userDocRef, {
          name: name || currentUser.displayName || '',
          age: age || '',
          gender: gender || '',
          bio: bio || '',
          photoURL: photoURL || ''
        }, { merge: true });

        // تحديث العرض الفوري في الشات
        displayName.textContent = name || currentUser.displayName || 'المستخدم';
        displayAgeGender.textContent = (age ? age + ' سنة' : '—') + (gender ? ' • ' + gender : '');
        displayBio.textContent = bio ? 'النبذة: ' + bio : 'النبذة: —';
        if (photoURL) { profileLarge.src = photoURL; setIconImage(photoURL); }

        // رسالة نجاح ملكية
        successToast.style.display = 'block';
        successToast.textContent = '✅ تم حفظ ملفك الشخصي بنجاح!';
        setTimeout(()=> successToast.style.display='none', 2500);

        tempPhotoFile = null;
      } catch (err) {
        console.error('save profile error', err);
        alert('حدث خطأ أثناء الحفظ، حاول مرة أخرى');
      } finally {
        saveProfileBtn.disabled = false;
        saveProfileBtn.textContent = '💾 حفظ التغييرات';
      }
    });

    // تحميل الرسائل من Firestore
    async function loadMessages(user){
      const q = query(collection(db,'messages'), orderBy('timestamp','asc'));
      onSnapshot(q, (snapshot)=>{
        messagesDiv.innerHTML = '';
        snapshot.forEach(snap=>{
          const d = snap.data();
          const div = document.createElement('div');
          div.className = 'msg';
          if (d.user === user.email) div.classList.add('me');
          div.textContent = `${d.user.split('@')[0]}: ${d.text}`;
          messagesDiv.appendChild(div);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
    }

    // إرسال رسالة
    sendBtn.addEventListener('click', async ()=>{
      const text = messageInput.value.trim();
      if (!text || !currentUser) return;
      await addDoc(collection(db,'messages'), {
        user: currentUser.email,
        text,
        timestamp: serverTimestamp()
      });
      messageInput.value = '';
    });

    // تسجيل الخروج
    document.getElementById('logoutBtn').addEventListener('click', async ()=>{
      await signOut(auth);
      window.location.href = 'login.html';
    });

    // منع البوب اب من الغلق عند الضغط داخله
    document.getElementById('profilePage').addEventListener('click', (e)=> e.stopPropagation());
  </script>
</body>
</html>