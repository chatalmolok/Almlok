<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { 
    getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, getDoc 
  } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDJhA1WkFsLZiQz5WZFWPFbdjxLPtG57ss",
    authDomain: "lloo-756f7.firebaseapp.com",
    projectId: "lloo-756f7",
    storageBucket: "lloo-756f7.firebasestorage.app",
    messagingSenderId: "951071688513",
    appId: "1:951071688513:web:b0fc76afe09001365043c0"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ðŸ§© Ø¯Ø§Ù„Ø© ØªØ¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Firestore Ø­Ø³Ø¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
  async function getUserName(email) {
    try {
      const userRef = doc(db, "users", email);
      const snapshot = await getDoc(userRef);
      if (snapshot.exists()) {
        return snapshot.data().username || email.split("@")[0];
      } else {
        return email.split("@")[0];
      }
    } catch (err) {
      console.error("âš ï¸ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø§Ø³Ù…:", err);
      return email.split("@")[0];
    }
  }

  const messagesRef = collection(db, "messages");
  const q = query(messagesRef, orderBy("timestamp", "asc"));
  const messagesDiv = document.getElementById("messages");
  const messageInput = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");

  // ðŸš€ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
  sendBtn.addEventListener("click", async () => {
    console.log("ðŸ“¨ Ø§Ù„Ø²Ø± Ø§Ø´ØªØºÙ„!");
    const text = messageInput.value.trim();
    if (text === "") return;

    const email = localStorage.getItem("userEmail");
    const username = await getUserName(email);

    await addDoc(messagesRef, {
      username,
      text,
      timestamp: new Date()
    });

    messageInput.value = "";
  });

  // ðŸ’¬ Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ø¨Ø§Ø´Ø±Ø©
  onSnapshot(q, (snapshot) => {
    messagesDiv.innerHTML = "";
    snapshot.forEach((docItem) => {
      const data = docItem.data();
      const messageElement = document.createElement("div");
      messageElement.classList.add("message");

      const time = data.timestamp?.toDate ? data.timestamp.toDate() : new Date();
      const timeString = time.toLocaleTimeString("ar-IQ", { hour: "2-digit", minute: "2-digit" });

      messageElement.innerHTML = `<strong>ðŸ‘‘ ${data.username || "Ù…Ø¬Ù‡ÙˆÙ„"} (ðŸ•’ ${timeString}):</strong> ${data.text}`;
      messagesDiv.appendChild(messageElement);
    });

    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
</script>